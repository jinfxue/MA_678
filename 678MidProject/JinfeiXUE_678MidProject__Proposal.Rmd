---
title: "Midterm Project Proposal"
author: "Jinfei Xue"
date: "12 November, 2018"
output:
  html_document:
    df_print: paged
  word_document: default
subtitle: Black Friday Analysis
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
#install.packages("Boruta")
#install.packages("randomForest")
#install.packages("maxLik")
#install.packages("olsrr")

library(dplyr)
library(tidyr)
library(ggplot2)
library(lme4)
library(Boruta)
#library(randomForest)
library(maxLik)
library(car) #vif
#library(olsrr) #ols_step_all_possible

```


# 1 Introduction

A retail company “ABC Private Limited” wants to understand the customer purchase behaviour (specifically, purchase amount) against various products of different categories. They have shared purchase summary of various customers for selected high volume products from last month. The data set also contains customer demographics (age, gender, marital status, city_type, stay_in_current_city), product details (product_id and product category) and Total purchase_amount of each client from last month.

Now, they want to build a model to predict the purchase amount of customer against the other variables which will help them to create personalized offer for customers. Here I have to mention that because of the privacy, the occupation, City_Category, product categories are masked and the categories are represented by numbers or letters.


# 2 Data

Both train and test data can be downloaded from the website https://datahack.analyticsvidhya.com/contest/black-friday/?utm_source=auto-email. The train dataset has 550,068 observations and 12 variables while the test data, which contains similar data as train except for their purchase amount, has 233,599 observations.

In the two datasets, the main variables are listed as follows:

- User_ID (as group)

- Gender (M/F)

- Age (Age in bins)

- Occupation (0, 1, ..., 20)

- City_Category (A/B/C)

- Stay_In_Current_City_Years (the number of years stay in current city)

- Marital_Status (0/1)

- Product_Category_1 (the number of bought products in category 1)

- Product_Category_2 (the number of bought products in category 2)

- Product_Category_3 (the number of bought products in category 3)

- Purchase (Purchase amount in dollars)

## 2.1 Dataset

```{r, message = FALSE, echo = FALSE} 
#input data
bf <- read.csv("train.csv")

#print head data
head(bf)
```

## 2.2 Train Data Structure
```{r, message = FALSE, echo = FALSE} 
#data structure
glimpse(bf)
summary(bf)
```

```{r}
sapply(bf, function(x) sum(is.na(x)))
# Because NAs only happen in product category variables and it represents the client didn't buy any products in the category, I replace NA with zero.
bf[is.na(bf)] <- 0
sum(is.na(bf)) #check

# transfer occupation to factor
bf$Occupation <- as.factor(bf$Occupation)
```


# 3 Exploratory Data Analysis

## 3.1 Total purchase distribution

```{r}
#total purchaser
bf %>%
  select(User_ID) %>%
  unique() %>%
  nrow() %>%
  paste("buyers registered at Black Friday")
```

```{r}
bf1 <- bf %>% 
  group_by(User_ID, Gender, Age, Occupation, City_Category, 
           Stay_In_Current_City_Years, Marital_Status) %>%
  summarise(total_Product_Category_1 = sum(Product_Category_1), 
            total_Product_Category_2 = sum(Product_Category_2),
            total_Product_Category_3 = sum(Product_Category_3),
            total_purchase = sum(Purchase)) 
summary(bf1$total_purchase)

ggplot(data = bf1, aes(x = total_purchase)) + 
  geom_histogram(col = 'black', fill = 'blue', binwidth = 300000, center = 150000) +
  labs(x = 'Dollars', y = 'the Number of Buyers', 
       title = "Figure3.1 Distribution of total purchasing by buyers") + 
  scale_y_continuous(limits = c(0,2000), breaks = c(0,500,1000,1500,2000)) + 
  scale_x_continuous(labels = scales::comma) #prevent scientific number in x-axis
```

## 3.2 Total number in each product category by gender

```{r}
bf2 <- bf %>%
  group_by(Gender) %>%
  summarise(Product_Category_1 = sum(Product_Category_1), 
            Product_Category_2 = sum(Product_Category_2), 
            Product_Category_3 = sum(Product_Category_3)) %>% 
  gather(key = Product_Category, value = total_number,
         Product_Category_1,Product_Category_2,Product_Category_3)

ggplot(data = bf2, aes(x=Product_Category, y = total_number,fill = Gender)) +
  geom_col() +
  labs(x = 'Product Category', y = 'Total Number (units)', 
       title = "Figure3.2 Total number in each product category by gender") + 
  guides(fill=guide_legend(title = "Gender")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis
```

We can see the product category 2 is most popular in the retail store.

## 3.3 Total purchasing in each city by gender

```{r}
bf3 <- bf %>%
  group_by(City_Category, Gender) %>%
  summarise(total_purchase = sum(Purchase))

ggplot(data = bf3, aes(x=City_Category, y = total_purchase, fill = Gender)) +
  geom_col() +
  labs(x = 'City Category', y = 'Total Purchase (dollars)', 
       title = "Figure3.3 Total purchasing in each city by gender") + 
  guides(fill=guide_legend(title = "Gender")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis
```


## 3.4 Purchasing in each age range by marital status
From the above data visualization,we find that men are morely to buy,so there comes our next question:men of what age will spend more money.Let's find out.
```{r, message=FALSE, warning=FALSE}
bf_age <- bf %>% 
  separate(Age,c("aa","bb")) %>% 
  mutate(aa=as.numeric(aa),bb=as.numeric(bb)) %>% 
  mutate(Age=(aa+bb)/2) %>% 
  select(-c(aa,bb))

bf4_1 <- bf_age %>% 
  mutate(age_range=case_when(Age <= 18 ~"Young",Age > 18 & Age <= 35 ~ "Mature",
                             Age > 35 & Age < 55 ~ "Middle-aged"))
bf4_1$age_range<-ifelse(is.na(bf4_1$age_range),"Old",bf4_1$age_range)
bf4_1$age_range<-factor(bf4_1$age_range, levels = c("Young", "Mature", "Middle-aged", "Old"))

attach(bf4_1)
bf4_1$Marital_Status[Marital_Status == 0] <- "Unmarried"
bf4_1$Marital_Status[Marital_Status == 1] <- "Married"

bf4_2 <- bf4_1 %>%
  group_by(age_range, Marital_Status) %>%
  summarise(total_purchase = sum(Purchase))
```

```{r}
ggplot(data = bf4_2, aes(x=age_range, y = total_purchase, fill = Marital_Status)) +
  geom_col() +
  labs(x = 'Age Range', y = 'Total Purchase (dollars)', 
       title = "Figure3.4 Total purchasing in each age range by marital status") + 
  guides(fill=guide_legend(title = "Marital Status")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis

```


```{r}
p1<-bf4_1 %>% 
  filter(Gender=="M") %>% 
  group_by(age_range,Marital_Status) %>% 
  summarise(purchase=median(Purchase)) %>%
  ggplot(aes(x=age_range,y=Marital_Status,fill=purchase))+
  geom_tile()+
  scale_fill_continuous(low="blue",high="red")+
  labs(x = 'Age Range', y = 'Marital Status', 
       title = "Figure3.4.1 Medium purchasing of male in each age range by marital status")
  
p2<-bf4_1 %>% 
  filter(Gender=="F") %>% 
  group_by(age_range,Marital_Status) %>% 
  summarise(purchase=median(Purchase)) %>%
  ggplot(aes(x=age_range,y=Marital_Status,fill=purchase))+
  geom_tile()+
  scale_fill_continuous(low="blue",high="red")+
  labs(x = 'Age Range', y = 'Marital Status', 
       title = "Figure3.4.2 Medium purchasing of female in each age range by marital status")

gridExtra::grid.arrange(p1,p2)
```

## 3.5 Purchasing in each age range by city category

```{r}
bf5 <- bf4_1 %>%
  group_by(age_range, City_Category) %>%
  summarise(total_purchase = sum(Purchase))

  
ggplot(data = bf5, aes(x=age_range, y = total_purchase, fill = City_Category)) +
  geom_col() +
  labs(x = 'Age', y = 'Total Purchase (dollars)', 
       title = "Figure3.5 Total purchasing in each age range by city category") + 
  guides(fill=guide_legend(title = "City Category")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis
```

```{r}
p3<-bf4_1 %>% 
  filter(Gender=="M") %>% 
  group_by(age_range,City_Category) %>% 
  summarise(purchase=median(Purchase)) %>%
  ggplot(aes(x=age_range,y=City_Category,fill=purchase))+
  geom_tile()+
  scale_fill_continuous(low="blue",high="red")+
  labs(x = 'Age Range', y = 'City Category', 
       title = "Figure3.5.1 Medium purchasing of male in each age range by city category")

p4<-bf4_1 %>% 
  filter(Gender=="F") %>% 
  group_by(age_range,City_Category) %>% 
  summarise(purchase=median(Purchase)) %>%
  ggplot(aes(x=age_range,y=City_Category,fill=purchase))+
  geom_tile()+
  scale_fill_continuous(low="blue",high="red")+
  labs(x = 'Age Range', y = 'City Category', 
       title = "Figure3.5.2 Medium purchasing of female in each age range by city category")

gridExtra::grid.arrange(p3,p4)
```

## 3.6 Toal purchasing in each occupation by city category

```{r}
bf6 <- bf %>%
  group_by(City_Category, Occupation) %>%
  summarise(total_purchase = sum(Purchase))

ggplot(data = bf6, aes(x=Occupation, y = total_purchase, fill = City_Category)) +
  geom_col() +
  labs(x = 'Occupation', y = 'Total Purchase (dollars)', 
       title = "Figure3.6 Toal purchasing in each occupation by city category") + 
  guides(fill=guide_legend(title = "City Category")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis
```

## 3.7 Toal purchasing in each occupation by city category

```{r}
bf7 <- bf %>%
  group_by(City_Category, Stay_In_Current_City_Years) %>%
  summarise(total_purchase = sum(Purchase))

ggplot(data = bf7, aes(x=Stay_In_Current_City_Years, y = total_purchase, fill = City_Category)) +
  geom_col() +
  labs(x = 'Years of Staying in Current City (years)', y = 'Total Purchase (dollars)', 
       title = "Figure3.7 Toal purchasing in each category of years of staying in current city by city category") + 
  guides(fill=guide_legend(title = "City Category")) + 
  scale_y_continuous(labels = scales::comma) #prevent scientific number in x-axis
```

# 4 Modeling and Prediction

## 4.1 Train and Test Datasets

```{r}
train <- read.csv("train.csv")
test <- read.csv("test.csv")

# Test whether User_ID in test dataset is a subset of User_ID in train dataset
sum(unique(test$User_ID) %in% unique(train$User_ID))==length(unique(test$User_ID))
```




```{r}
#rf = randomForest(Purchase ~ Gender + Age + Occupation + City_Category + 
                    #Stay_In_Current_City_Years + Marital_Status, data=bf)
#importance(fit_rf)
# compare the feature importance with varImp() function
#varImp(fit_rf)
# Create a plot of importance scores by random forest
#varImpPlot(fit_rf)






```



## 4.2 Modeling

The predictors include "Gender", "Age", "Occupation", "City_Category", "Stay_In_Current_City_Years", "Marital_Status", "Product_Category_1", "Product_Category_2" and "Product_Category_3". The response variable is "Purchase".


### 4.2.1 Linear regression model

```{r}
library(MASS)
# Fit the full model 
r1 <- lm(Purchase ~., data = train)
# Stepwise regression model
r1_step <- stepAIC(r1, direction = "both", 
                      trace = FALSE)
summary(step.model)





r1 <- lm(Purchase ~ Gender + Age + Occupation + City_Category + 
           Stay_In_Current_City_Years + Marital_Status + Product_Category_1 + 
           Product_Category_2 + Product_Category_3, data = bf)
summary(r1)

# Residual Plot
plot(r1, which = 1)

# Marginal model plots
#marginalModelPlots(r1)
```

From the residual plot, we can see that the points are not randomly dispersed around the horizontal line at zero(the dashed black line).


```{r}
# standardize the "purchase" variable
bf$sd_purchase <- (bf$Purchase-mean(bf$Purchase))/sd(bf$Purchase)
r2 <- lm(sd_purchase ~ Gender + Age + Occupation + City_Category + 
           Stay_In_Current_City_Years + Marital_Status + Product_Category_1 + 
           Product_Category_2 + Product_Category_3, data = bf)



r2 <- lm(sd_purchase ~ Gender + Age + Occupation + City_Category + 
           Stay_In_Current_City_Years + Marital_Status + Product_Category_1 + 
           Product_Category_2 + Product_Category_3, data = bf)
summary(r2)

# Residual Plot
plot(r2, which = 1)

# Marginal model plots
#marginalModelPlots(r2)
```

There still exists trends in the residual plot. Then I will try multilevel models.


### 4.2.2 Multilevel regression (vary by intercept)

Individual level variables include "Product_Category_1", "Product_Category_2" and "Product_Category_3". Group level variables include "Gender", "Age", "Occupation", "City_Category", "Stay_In_Current_City_Years" and "Marital_Status".

```{r}
# Locate group level variables
for (i in 2:5) {
  
}
tt <- tapply(bf$Product_ID, bf$User_ID, 
             function(x) {
               length(unique(x))
             })
names(tt)[tt > 1]
```

```{r}
ggplot(bf) + aes(x=,y=Purchase,group=User_ID) + 
  geom_line(alpha=0.3) + geom_smooth(method="lm",aes(group=1)) + 
  ylab("Purchase")
```




```{r}
r1 <- lmer(Purchase ~ Product_Category_1 + Product_Category_2 + 
             Product_Category_3 + (1|User_ID), data = bf, REML=FALSE)
summary(r1)
```

### 4.2.3 Multilevel regression (varying slopes)

```{r}
r2 <- lmer(Purchase ~ Product_Category_1 + Product_Category_2 + 
             Product_Category_3 + (1|User_ID), data = bf)
summary(r2)
```


```{r}
#createDataPartition
```

### 4.2.4 Multilevel generalized linear models

From figure(distribution), we can see the black friday purchase data has the 

```{r}

#summary(bf$Purchase)
#summary(bf1$log.total)

ggplot(data = bf1, aes(x = log.total)) + 
  geom_histogram(col = 'black', fill = 'blue', binwidth = 0.05, center = 12) +
  labs(x = 'Dollars', y = 'the Number of Buyers', 
       title = "Figure3.1 Distribution of total purchasing by buyers")


ggplot(data = bf1, aes(x = total_purchase)) + 
  geom_histogram(col = 'black', fill = 'blue', binwidth = 300000, center = 150000) +
  labs(x = 'Dollars', y = 'the Number of Buyers', 
       title = "Figure3.1 Distribution of total purchasing by buyers") + 
  scale_y_continuous(limits = c(0,2000), breaks = c(0,500,1000,1500,2000)) + 
  scale_x_continuous(labels = scales::comma) #prevent scientific number in x-axis





```





## 4.3 Model Checking

```{r}

```

## 4.3 Prediction


# 5 Modeling and Prediction (for total_purchase)

## 5.1 

## 5.2 Modeling

### 5.2.1 Linear regression model

```{r}
# Do the log transformation for "total_purchase"
bf1$log.total <- log(bf1$total_purchase)
summary(bf1$log.total)

ggplot(data = bf1, aes(x = log.total)) + 
  geom_histogram(col = 'black', fill = 'blue', binwidth = 0.05, center = 12) +
  labs(x = 'Dollars', y = 'the Number of Buyers', 
       title = "Figure5.1 Distribution of log(total_purchase) by buyers")
```

```{r}

R1 <- lm(total_purchase ~ Gender + Age + Occupation + City_Category + 
           Stay_In_Current_City_Years + Marital_Status + total_Product_Category_1 + 
           total_Product_Category_2 + total_Product_Category_3, data = bf1)
summary(R1)

#chisq.test(bf1)
```

```{r}
test <- read.csv("test.csv")
glimpse(test)
```







## 5.3 


# 3 Objectives

* Clean Data
* Exploratory Data Analysis: *creating graphics*.
* Modeling and Prediction: *using multilevel model, model checking and prediction*.
* Assessment and Discussions: *assessing the limitations of the result and discussing future research directions*.
